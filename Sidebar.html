<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <style>
        body {
            padding: 10px;
            font-family: 'Google Sans', sans-serif;
        }

        .section {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
        }

        .scroll-box {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
        }

        .pledge-item {
            display: flex;
            align-items: center;
            padding: 4px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        .pledge-item:last-child {
            border-bottom: none;
        }

        .pledge-item input {
            margin-right: 8px;
        }

        .pledge-info {
            flex-grow: 1;
        }

        .pledge-amt {
            font-weight: bold;
            color: #1a73e8;
        }

        /* Dynamic Preview Area */
        #previewArea {
            margin-top: 10px;
        }

        iframe {
            width: 100%;
            height: 180px;
            border: 1px solid #eee;
        }

        .mini-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
        }

        .mini-table th,
        .mini-table td {
            border: 1px solid #ddd;
            padding: 4px;
        }

        .total-bar {
            background: #e8f0fe;
            color: #1a73e8;
            padding: 10px;
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            margin: 10px 0;
        }

        button.action {
            width: 100%;
            height: 36px;
            font-weight: bold;
        }

        .error {
            color: red;
            font-size: 11px;
            display: none;
        }
    </style>
</head>

<body>

    <!-- 1. PLEDGE PICKER -->
    <div class="section">
        <div class="header">Select Pledges (Available Funds)</div>
        <div id="pledgeList" class="scroll-box">
            Loading funds...
        </div>
        <div class="total-bar">
            Selected Total: <span id="totalSelected">0</span>
        </div>
    </div>

    <!-- 2. DYNAMIC PREVIEW -->
    <div class="section" id="previewSection" style="display:none;">
        <div class="header">Proof of Payment</div>
        <div id="previewArea"></div> <!-- Iframe or Table goes here -->
    </div>

    <!-- 3. STUDENT SELECTOR -->
    <div class="section">
        <div class="header">Allocate To Student</div>
        <input list="studentList" id="cmsInput" placeholder="Search CMS ID..." style="width:100%">
        <datalist id="studentList"></datalist>
        <div style="font-size:12px; color:#666; margin-top:4px;">
            Student Need: <span id="studentNeed">--</span>
        </div>
    </div>

    <!-- 4. ACTION -->
    <button class="action share" id="btnAllocate" onclick="runBatchAllocation()">ALLOCATE BATCH</button>
    <div id="msg" class="error"></div>

    <script>
        let allPledges = [];
        let selectedPledges = [];

        window.onload = function () {
            google.script.run.withSuccessHandler(initUI).getAvailablePledgesForSidebar();
        };

        function initUI(data) {
            allPledges = data.pledges;
            renderPledgeList(allPledges);

            // Populate Students
            const dl = document.getElementById('studentList');
            data.students.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.cmsId;
                opt.label = `Need: ${s.need.toLocaleString()}`;
                dl.appendChild(opt);
            });
        }

        function renderPledgeList(list) {
            const container = document.getElementById('pledgeList');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<div style="padding:10px">No funds available.</div>';
                return;
            }

            list.forEach(p => {
                const div = document.createElement('div');
                div.className = 'pledge-item';
                div.innerHTML = `
                    <input type="checkbox" value="${p.id}" onchange="updateSelection(this, '${p.id}', ${p.amount})">
                    <div class="pledge-info">
                        <div>${p.name}</div>
                        <div style="color:#666; font-size:10px;">${p.id}</div>
                    </div>
                    <input type="number" id="amt_${p.id}" value="${p.amount}" max="${p.amount}" min="1" 
                           style="width: 70px; font-size:11px;" onchange="updateAmount('${p.id}')">
                `;
                container.appendChild(div);
            });
        }

        function updateSelection(checkbox, pId, maxAmt) {
            const amtInput = document.getElementById(`amt_${pId}`);

            if (checkbox.checked) {
                // Add to selection using current input value
                const currentVal = Number(amtInput.value);
                const pData = allPledges.find(p => p.id === pId);
                // Create a copy with the manual amount
                selectedPledges.push({ ...pData, amount: currentVal });
            } else {
                // Remove
                selectedPledges = selectedPledges.filter(p => p.id !== pId);
            }
            renderPreview();
        }

        function updateAmount(pId) {
            // Find if this pledge is currently checked
            const idx = selectedPledges.findIndex(p => p.id === pId);
            if (idx !== -1) {
                const amtInput = document.getElementById(`amt_${pId}`);
                let val = Number(amtInput.value);
                const max = Number(amtInput.getAttribute('max'));

                // Enforce max
                if (val > max) {
                    val = max;
                    amtInput.value = max;
                }

                selectedPledges[idx].amount = val;
                renderPreview();
            }
        }

        // ... renderPreview remains mostly same but uses p.amount ...

        function renderPreview() {
            const area = document.getElementById('previewArea');
            const sec = document.getElementById('previewSection');
            const totalDisplay = document.getElementById('totalSelected');

            // Update Total
            const total = selectedPledges.reduce((sum, p) => sum + p.amount, 0);
            totalDisplay.innerText = total.toLocaleString();

            if (selectedPledges.length === 0) {
                sec.style.display = 'none';
                return;
            }

            sec.style.display = 'block';

            // DYNAMIC VIEW LOGIC
            if (selectedPledges.length === 1) {
                // Show Single Iframe
                const link = selectedPledges[0].proofLink.replace('/view', '/preview');
                area.innerHTML = `<iframe src="${link}"></iframe>`;
            } else {
                // Show Table for Multiple
                let html = `<table class="mini-table"><tr><th>Donor</th><th>Ref</th><th>Alloc</th><th>Receipt</th></tr>`;
                selectedPledges.forEach(p => {
                    html += `<tr>
                        <td>${p.name}</td>
                        <td>${p.id}</td>
                        <td>${p.amount.toLocaleString()}</td> 
                        <td><a href="${p.proofLink}" target="_blank">View</a></td>
                    </tr>`;
                });
                html += `</table>`;

                if (selectedPledges.length > 5) {
                    html += `<div style="color:orange; font-size:10px; margin-top:5px;">⚠️ High volume: Mailto link might be truncated.</div>`;
                }
                area.innerHTML = html;
            }
        }

        function runBatchAllocation() {
            const cmsId = document.getElementById('cmsInput').value;
            const btn = document.getElementById('btnAllocate');
            const msg = document.getElementById('msg');

            if (!cmsId || selectedPledges.length === 0) {
                msg.style.display = 'block';
                msg.innerText = "Please select at least one pledge and a student.";
                return;
            }

            // Lock UI
            btn.disabled = true;
            btn.innerText = "Processing...";
            msg.style.display = 'none';

            // Send Objects {id, amount} instead of strings
            const pledgePayload = selectedPledges.map(p => ({
                id: p.id,
                amount: p.amount
            }));

            google.script.run
                .withSuccessHandler(() => {
                    btn.innerText = "Success!";
                    msg.style.display = 'block';
                    msg.style.color = 'green';
                    msg.innerText = "Batch Processed & Email Generated.";
                    setTimeout(function () { window.onload(); }, 2000); // Reload
                })
                .withFailureHandler((e) => {
                    btn.disabled = false;
                    btn.innerText = "ALLOCATE BATCH";
                    msg.style.display = 'block';
                    msg.style.color = 'red';
                    msg.innerText = e.message;
                })
                .processBatchAllocation(pledgePayload, cmsId);
        }
    </script>
</body>

</html>