<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <style>
        body {
            padding: 10px;
            font-family: 'Google Sans', sans-serif;
        }

        .section {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
        }

        .scroll-box {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
        }

        .pledge-item {
            display: flex;
            align-items: center;
            padding: 4px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        .pledge-item:last-child {
            border-bottom: none;
        }

        .pledge-item input {
            margin-right: 8px;
        }

        .pledge-info {
            flex-grow: 1;
        }

        .pledge-amt {
            font-weight: bold;
            color: #1a73e8;
        }

        /* Dynamic Preview Area */
        #previewArea {
            margin-top: 10px;
        }

        iframe {
            width: 100%;
            height: 180px;
            border: 1px solid #eee;
        }

        .mini-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
        }

        .mini-table th,
        .mini-table td {
            border: 1px solid #ddd;
            padding: 4px;
        }

        .total-bar {
            background: #e8f0fe;
            color: #1a73e8;
            padding: 10px;
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            margin: 10px 0;
        }

        button.action {
            width: 100%;
            height: 36px;
            font-weight: bold;
        }

        .error {
            color: red;
            font-size: 11px;
            display: none;
        }
    </style>
</head>

<body>

    <!-- 1. PLEDGE PICKER -->
    <div class="section">
        <div class="header">Select Pledges (Available Funds)</div>
        <div id="pledgeList" class="scroll-box">
            Loading funds...
        </div>
        <div class="total-bar">
            Selected Total: <span id="totalSelected">0</span>
        </div>
    </div>

    <!-- 2. DYNAMIC PREVIEW -->
    <div class="section" id="previewSection" style="display:none;">
        <div class="header">Proof of Payment</div>
        <div id="previewArea"></div> <!-- Iframe or Table goes here -->
    </div>

    <!-- 3. STUDENT SELECTOR (Multi-Student Support) -->
    <div class="section">
        <div class="header">Allocate To Students</div>
        <input list="studentList" id="cmsInput" placeholder="Search CMS ID... (press Enter to add)" style="width:100%">
        <datalist id="studentList"></datalist>

        <div id="selectedStudents" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;"></div>

        <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px;">
            <label style="font-size: 11px;">
                <input type="checkbox" id="equalDistribution" checked onchange="toggleDistributionMode()">
                Equal Distribution
            </label>
            <span style="font-size: 10px; color: #666;" id="distributionHint">(splits selected funds equally)</span>
        </div>

        <div id="studentAmountsSection" style="display: none; margin-top: 8px;">
            <div style="font-size: 11px; color: #666; margin-bottom: 4px;">Specify amount per student:</div>
            <div id="studentAmountInputs"></div>
        </div>
    </div>

    <!-- 4. ACTION -->
    <button class="action share" id="btnAllocate" onclick="runBatchAllocation()">ALLOCATE BATCH</button>
    <div id="msg" class="error"></div>

    <script>
        let allPledges = [];
        let selectedPledges = [];
        let allStudents = [];
        let selectedStudents = []; // [V59.4] Array of selected students

        window.onload = function () {
            google.script.run.withSuccessHandler(initUI).getAvailablePledgesForSidebar();
        };

        function initUI(data) {
            allPledges = data.pledges;
            allStudents = data.students; // Store for lookup
            renderPledgeList(allPledges);

            // Populate Students Datalist
            const dl = document.getElementById('studentList');
            data.students.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.cmsId;
                opt.label = `Need: ${s.need.toLocaleString()}`;
                dl.appendChild(opt);
            });

            // [V59.4] Listen for Enter key to add student
            document.getElementById('cmsInput').addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addStudent();
                }
            });
        }

        // [V59.4] Add student to selection
        function addStudent() {
            const input = document.getElementById('cmsInput');
            const cmsId = input.value.trim();
            if (!cmsId) return;

            // Check if already selected
            if (selectedStudents.find(s => s.cmsId === cmsId)) {
                input.value = '';
                return;
            }

            // Find student data
            const studentData = allStudents.find(s => s.cmsId === cmsId);
            if (!studentData) {
                alert('Student not found: ' + cmsId);
                return;
            }

            selectedStudents.push({
                cmsId: cmsId,
                need: studentData.need,
                amount: null // Will be calculated or specified
            });

            input.value = '';
            renderSelectedStudents();
        }

        // [V59.4] Remove student from selection
        function removeStudent(cmsId) {
            selectedStudents = selectedStudents.filter(s => s.cmsId !== cmsId);
            renderSelectedStudents();
        }

        // [V59.4] Render selected students as chips
        function renderSelectedStudents() {
            const container = document.getElementById('selectedStudents');
            const amountsSection = document.getElementById('studentAmountsSection');
            const amountsContainer = document.getElementById('studentAmountInputs');
            const isEqual = document.getElementById('equalDistribution').checked;

            // Render chips
            container.innerHTML = selectedStudents.map(s => `
                <span style="background: #e8f0fe; padding: 4px 8px; border-radius: 12px; font-size: 11px; display: inline-flex; align-items: center; gap: 4px;">
                    ${s.cmsId}
                    <span style="cursor: pointer; color: #666;" onclick="removeStudent('${s.cmsId}')">&times;</span>
                </span>
            `).join('');

            // Render amount inputs if not equal distribution
            if (!isEqual && selectedStudents.length > 0) {
                amountsSection.style.display = 'block';
                amountsContainer.innerHTML = selectedStudents.map(s => `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span style="font-size: 11px; width: 80px;">${s.cmsId}:</span>
                        <input type="number" id="studentAmt_${s.cmsId}" value="${s.amount || ''}" 
                               placeholder="Amount" style="width: 80px; font-size: 11px;"
                               onchange="updateStudentAmount('${s.cmsId}')">
                        <span style="font-size: 10px; color: #666;">Need: ${s.need.toLocaleString()}</span>
                    </div>
                `).join('');
            } else {
                amountsSection.style.display = 'none';
            }
        }

        // [V59.4] Update student amount
        function updateStudentAmount(cmsId) {
            const input = document.getElementById(`studentAmt_${cmsId}`);
            const student = selectedStudents.find(s => s.cmsId === cmsId);
            if (student && input) {
                student.amount = Number(input.value) || null;
            }
        }

        // [V59.4] Toggle between equal distribution and manual amounts
        function toggleDistributionMode() {
            const isEqual = document.getElementById('equalDistribution').checked;
            const hint = document.getElementById('distributionHint');

            if (isEqual) {
                hint.innerText = '(splits selected funds equally)';
                // Clear manual amounts
                selectedStudents.forEach(s => s.amount = null);
            } else {
                hint.innerText = '(specify amount per student)';
            }
            renderSelectedStudents();
        }

        function renderPledgeList(list) {
            const container = document.getElementById('pledgeList');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<div style="padding:10px">No funds available.</div>';
                return;
            }

            list.forEach(p => {
                const div = document.createElement('div');
                div.className = 'pledge-item';
                div.innerHTML = `
                    <input type="checkbox" value="${p.id}" onchange="updateSelection(this, '${p.id}', ${p.amount})">
                    <div class="pledge-info">
                        <div>${p.name}</div>
                        <div style="color:#666; font-size:10px;">${p.id}</div>
                    </div>
                    <input type="number" id="amt_${p.id}" value="${p.amount}" max="${p.amount}" min="1" 
                           style="width: 70px; font-size:11px;" onchange="updateAmount('${p.id}')">
                `;
                container.appendChild(div);
            });
        }

        function updateSelection(checkbox, pId, maxAmt) {
            const amtInput = document.getElementById(`amt_${pId}`);

            if (checkbox.checked) {
                const currentVal = Number(amtInput.value);
                const pData = allPledges.find(p => p.id === pId);
                selectedPledges.push({ ...pData, amount: currentVal });
            } else {
                selectedPledges = selectedPledges.filter(p => p.id !== pId);
            }
            renderPreview();
        }

        function updateAmount(pId) {
            const idx = selectedPledges.findIndex(p => p.id === pId);
            if (idx !== -1) {
                const amtInput = document.getElementById(`amt_${pId}`);
                let val = Number(amtInput.value);
                const max = Number(amtInput.getAttribute('max'));

                if (val > max) {
                    val = max;
                    amtInput.value = max;
                }

                selectedPledges[idx].amount = val;
                renderPreview();
            }
        }

        function renderPreview() {
            const area = document.getElementById('previewArea');
            const sec = document.getElementById('previewSection');
            const totalDisplay = document.getElementById('totalSelected');

            const total = selectedPledges.reduce((sum, p) => sum + p.amount, 0);
            totalDisplay.innerText = total.toLocaleString();

            if (selectedPledges.length === 0) {
                sec.style.display = 'none';
                return;
            }

            sec.style.display = 'block';

            if (selectedPledges.length === 1) {
                const link = selectedPledges[0].proofLink.replace('/view', '/preview');
                area.innerHTML = `<iframe src="${link}"></iframe>`;
            } else {
                let html = `<table class="mini-table"><tr><th>Donor</th><th>Ref</th><th>Alloc</th><th>Receipt</th></tr>`;
                selectedPledges.forEach(p => {
                    html += `<tr>
                        <td>${p.name}</td>
                        <td>${p.id}</td>
                        <td>${p.amount.toLocaleString()}</td> 
                        <td><a href="${p.proofLink}" target="_blank">View</a></td>
                    </tr>`;
                });
                html += `</table>`;

                if (selectedPledges.length > 5) {
                    html += `<div style="color:orange; font-size:10px; margin-top:5px;">⚠️ High volume: Mailto link might be truncated.</div>`;
                }
                area.innerHTML = html;
            }
        }

        // [V59.4] Updated to support multiple students
        function runBatchAllocation() {
            const btn = document.getElementById('btnAllocate');
            const msg = document.getElementById('msg');
            const isEqual = document.getElementById('equalDistribution').checked;

            // Validation
            if (selectedStudents.length === 0) {
                msg.style.display = 'block';
                msg.innerText = "Please add at least one student.";
                return;
            }
            if (selectedPledges.length === 0) {
                msg.style.display = 'block';
                msg.innerText = "Please select at least one pledge.";
                return;
            }

            // Lock UI
            btn.disabled = true;
            btn.innerText = "Processing...";
            msg.style.display = 'none';

            // Build pledge payload
            const pledgePayload = selectedPledges.map(p => ({
                id: p.id,
                amount: p.amount
            }));

            // [V59.4] Build students payload based on distribution mode
            let studentPayload;
            if (isEqual) {
                // Equal distribution: pass string IDs only
                studentPayload = selectedStudents.map(s => s.cmsId);
            } else {
                // Explicit amounts: pass objects with amounts
                studentPayload = selectedStudents.map(s => ({
                    cmsId: s.cmsId,
                    amount: s.amount || null
                }));
            }

            google.script.run
                .withSuccessHandler(() => {
                    btn.innerText = "Success!";
                    msg.style.display = 'block';
                    msg.style.color = 'green';
                    msg.innerText = `Batch Processed for ${selectedStudents.length} student(s).`;
                    // Reset selection
                    selectedStudents = [];
                    selectedPledges = [];
                    setTimeout(function () { window.onload(); }, 2000);
                })
                .withFailureHandler((e) => {
                    btn.disabled = false;
                    btn.innerText = "ALLOCATE BATCH";
                    msg.style.display = 'block';
                    msg.style.color = 'red';
                    msg.innerText = e.message;
                })
                .processBatchAllocation(pledgePayload, studentPayload);
        }
    </script>
</body>

</html>